---
title: "[ASM] μ¤νƒ λ©”λ¨λ¦¬μ™€ μ¤νƒ ν”„λ μ„"
excerpt: "μ–΄μ…λΈ”λ¦¬μ–΄μ—μ„ μ¤νƒ λ©”λ¨λ¦¬μ™€ μ¤νƒ ν”„λ μ„μ— λ€ν•΄ μ•μ•„λ³΄κΈ°"

categories:
  - Assembly Language
tags:
  - [study, asm, assembly, stack, memory, stack memory, stack frame]

permalink: /asm/stack/

toc: true
toc_sticky: true

date: 2022-11-16 17:52:20+0900
last_modified_at: 2022-11-16 17:52:23+0900
---

## π‘» μ¤νƒ λ©”λ¨λ¦¬
μ¤νƒ λ©”λ¨λ¦¬(Stack Memory)λ” λ©”λ¨λ¦¬ λ‚΄μ— ν• λ‹Ήλμ–΄μλ” ν• μμ—­μΌλ΅ μΌλ°μ μΈ λ©”λ¨λ¦¬μ™€ λ‹¤λ¥Έ μ €μ¥ λ°©μ‹κ³Ό κµ¬μ΅°λ¥Ό κ°€μ§„λ‹¤. ν•¨μκ°€ μ‚¬μ©ν•λ” μΌμΆ…μ **λ©”λ¨μ¥**μ΄λΌκ³  μƒκ°ν•λ©΄ λλ‹¤.

> μν™” _μΈμ…‰μ…_ μΌλ΅ λΉ„μ ν•΄λ³΄λ©΄   
- κΏμ΄ μ ν¨ν• λ™μ•μ—λ” κ·Έ κΏμ„ μ μ§€μ‹μΌμ•Ό ν•λ‹¤.
    - μ ν¨ λ²”μ„μ κ°λ…μ΄ μλ‹¤.
- κΏμ΄ λλ‚λ©΄ κ·Έ κΏμ„ λ¶€μ…”λ²„λ ¤λ„ λλ‹¤.
    - μ •λ¦¬μ κ°λ…μ΄ μλ‹¤.
- κΏμ—μ„λ„ λ κΏμ„ κΏ€ μ μλ‹¤λ” κ²ƒμ„ κ³ λ ¤ν•΄μ•Ό ν•λ‹¤.
    - μ λ™μ μΌλ΅ μ ν¨ λ²”μ„κ°€ ν™•μ¥μ΄ κ°€λ¥ν•λ‹¤.

μ΄λ¬ν• μ΅°κ±΄μ„ λ¨λ‘ λ§μ΅±ν•λ” κ² λ°”λ΅ **μ¤νƒ λ©”λ¨λ¦¬**μ΄λ‹¤. μ¤νƒ λ©”λ¨λ¦¬λ” κΈ°λ³Έμ μΌλ΅ **ν›„μ…μ„ μ¶(LIFO : Last In First Out)** μμΌλ΅ λ°μ΄ν„°κ°€ μ΄λ™λλ©° λ†’μ€ μ£Όμ†λ¶€ν„° λ‚®μ€ μ£Όμ† μμΌλ΅ λ°μ΄ν„°κ°€ μ €μ¥λλ‹¤.

μ¤νƒ λ©”λ¨λ¦¬μ— λ°μ΄ν„°λ¥Ό λ„£μ„ λ• ``` push ```, κΊΌλ‚Ό λ• ``` pop ``` λ…λ Ήμ–΄λ¥Ό μ‚¬μ©ν•λ‹¤.

> π’΅ **λ‹¤μ–‘ν• μ©λ„λ΅ μ‚¬μ©λλ” λ μ§€μ¤ν„°**   
- a, b, c, dλ” **λ²”μ© λ μ§€μ¤ν„°**μ΄λ‹¤.
- **ν¬μΈν„° λ μ§€μ¤ν„°** : μ„μΉλ¥Ό κ°€λ¦¬ν‚¤λ”, μ¤νƒκ³Ό κ΄€λ ¨λ λ μ§€μ¤ν„°μ΄λ‹¤.
    - **ip (Instruction Pointer)** : λ‹¤μ μν–‰ λ…λ Ήμ–΄μ μ„μΉ
    - **sp (Stack Pointer)** : ν„μ¬ μ¤νƒ top μ„μΉ(μΌμΆ…μ cursor)
    - **bp (Base Pointer)** : μ¤νƒ μƒλ€μ£Όμ† κ³„μ‚°μ©
- 64λΉ„νΈλ΅ μ—°μ‚°μ„ ν•λ©΄ μ•μ— **r**μ΄ λ¶™λ”λ‹¤.
>
> λ””λ²„κΉ…μ„ μ‹¤ν–‰ν•λ©΄ ``` mov rbp, rsp ```κ°€ ν• μ¤„ μ¶”κ°€λλ”λ° λ°”λ΅ μ¤νƒμ—μ„ μ‚¬μ©ν•λ” ν¬μΈν„°λ¥Ό μλ―Έν•λ‹¤.

***

### π± λ°μ΄ν„° μ΄λ™ ν™•μΈν•΄λ³΄κΈ°
```
push 1
push 2
push 3

pop rax
pop rbx
pop rcx
```

μ„μ μ½”λ“λ¥Ό λ””λ²„κΉ… ν•΄λ³΄μ.

![Alt Text](/assets/images/posts_img/basics/asm/stack/register.PNG)   

λ μ§€μ¤ν„° μ°½μ—μ„ μ΄μ  rbp, rsp, ripμ μλ―Έλ¥Ό κ°κ° μ• μ μκ² λμ—λ‹¤. **rsp**κ°€ ν„μ¬ μ¤νƒμ„ κ°€λ¦¬ν‚¤κ³  μμΌλ‹ ν•΄λ‹Ή μ£Όμ†κ°’μ„ λ©”λ¨λ¦¬μ— λ¶™μ—¬λ„£μ–΄ ν™•μΈν•΄λ³΄μ. μ΄μ  **Address**λ¥Ό μ²΄ν¬ν•΄μ£Όμ–΄μ•Όν•λ‹¤.

![Alt Text](/assets/images/posts_img/basics/asm/stack/memory.PNG)   

ν„μ¬ rspμ μ„μΉλ” ``` 0x60fe38 ```μ΄κ³  8 λ°”μ΄νΈμ”© λ‚νƒ€λ‚΄κ³  μλ‹¤. μ¤νƒ λ©”λ¨λ¦¬λ” λ†’μ€ μ£Όμ†μ—μ„ λ‚®μ€ μ£Όμ† μμΌλ΅ μ €μ¥λλ―€λ΅ λ°μ΄ν„°κ°€ μ–΄λ–»κ² μ΄λ™λλ”μ§€ ν™•μΈν•κΈ° μ„ν•΄ μ£Όμ†λ¥Ό 8 λ°”μ΄νΈμ”© μ΄λ™ν•΄μ„ μ „λ¶€ λ³΄λ ¤κ³  μ €λ ‡κ² μ„¤μ •ν•΄λ‘μ—λ‹¤. μ—¬κΈ°κΉμ§€ ν•κ³  **F10**μ„ λλ¬ ν• μ¤„μ”© λ””λ²„κΉ…ν•΄λ³΄μ.

> ``` push ```λ” **x86(32λΉ„νΈ ν”„λ΅κ·Έλ¨) ν™κ²½**μ—μ„  **4λ°”μ΄νΈ(32λΉ„νΈ)**,   
**x64(64λΉ„νΈ ν”„λ΅κ·Έλ¨) ν™κ²½**μ—μ„  **8λ°”μ΄νΈ(64λΉ„νΈ)** λ‹¨μ„λ΅ μ›€μ§μΈλ‹¤.

![Alt Text](/assets/images/posts_img/basics/asm/stack/memory2.PNG)   

ν„μ¬ λ””λ²„κΉ… μ½”λ“μ μ„μΉλ” ``` push 2 ```λ¥Ό κ°€λ¦¬ν‚¤κ³  μλ‹¤. ``` push 1 ```μ΄ μ‹¤ν–‰λμ—λ‹¤λ” μλ―Έμ΄λ‹¤. λ©”λ¨λ¦¬ μ°½μ„ μ‚΄ν΄λ³΄λ©΄ 8λ°”μ΄νΈ μ΄μ „ μ£Όμ†κ°’μ— **1**μ΄ λ“¤μ–΄κ°„ κ²ƒμ„ ν™•μΈν•  μ μλ‹¤. κ°’μ μ €μ¥μ€ λ¦¬ν‹€ μ—”λ””μ–Έ λ°©μ‹μ΄λ‹¤.

![Alt Text](/assets/images/posts_img/basics/asm/stack/memory3.PNG)   

``` push 3 ```κΉμ§€ λλ‚΄λ©΄ κ°’μ΄ μ΄λ ‡κ² μ λ“¤μ–΄κ°„ κ²ƒμ„ μ• μ μλ‹¤. μ΄μ  **pop**μ„ ν•΄λ³΄λ©΄ κ°κ°μ λ μ§€μ¤ν„°μ— κ°’μ΄ μ°¨λ΅€λ΅ λ“¤μ–΄κ°”λ‹¤λ” κ²ƒμ„ μ• μ μλ‹¤.

![Alt Text](/assets/images/posts_img/basics/asm/stack/register2.PNG)   

κ°€μ¥ λ§μ§€λ§‰μ— λ“¤μ–΄κ°„ κ°’μ΄ μ μΌ λ¨Όμ € λ‚μ¤λ―€λ΅ ``` rax ```μ—λ” λ§μ§€λ§‰μΌλ΅ λ“¤μ–΄κ°”λ **3**μ΄ λ“¤μ–΄κ°€κ² λλ‹¤. λ©”λ¨λ¦¬μ—” κ°’μ΄ κ·Έλ€λ΅ μλ” κ±Έ ν™•μΈν•  μ μλ”λ°, ``` pop ```μ„ ν•΄λ„ **λ©”λ¨λ¦¬μ— μλ” κ°’μ€ λ³€κ²½λμ§€ μ•κ³  μ ν¨ λ²”μ„λ§ λ°”λ€λ‹¤**κ³  λ³΄λ©΄ λλ‹¤.

***

### π± μ¤νƒ ν”„λ μ„
> ν•¨μ μ‹κ°„μ— ν•΄λ΄¤λ MAX ν•¨μλ¥Ό μ¤νƒμ„ μ‚¬μ©ν•΄ κµ¬ν„ν•΄λ³΄μ.

```
    push 1
    push 2
    call MAX
    PRINT_DEC 8, rax
    NEWLINE
    add rsp, 16 ; μ¤νƒ μ΄κΈ°ν™”. μ• ν•΄μ£Όλ©΄ μ—λ¬λ‚¨ 

    xor rax, rax
    ret

MAX:
    push rbp
    mov rbp, rsp

    mov rax, [rbp+16]
    mov rbx, [rbp+24]
    cmp rax, rbx
    jg L1
    mov rax, rbx
L1:
    pop rbp
    ret
```

![Alt Text](/assets/images/posts_img/basics/asm/stack/stack.PNG)   

μ„μ μ¤νƒ λ©”λ¨λ¦¬ μ΄λ―Έμ§€λ¥Ό μ°Έκ³ ν•λ©΄, κ³ μ •λ bpκ°’μ„ μ΄μ©ν•΄ pushλ¥Ό μ΄μ©ν•΄ μ €μ¥ν• λ§¤κ°λ³€μ 1, 2μ μƒλ€μ£Όμ†λ¥Ό κµ¬ν•κ²λλ‹¤. 64λΉ„νΈ ν™κ²½μ—μ„λ” 8λ°”μ΄νΈμ”© μ›€μ§μ΄λ―€λ΅ raxμ—λ” 2μ κ°’μ„, rbxμ—λ” 1μ κ°’μ„ λ„£μ–΄μ¤¬λ‹¤κ³  λ³΄λ©΄ λλ‹¤. μ΄μ „ bpκ°’μ μ£Όμ†κ°€ λ§¤κ°λ³€μ μ£Όμ†λ³΄λ‹¤ λ‚®μΌλ―€λ΅ κ°κ° 16κ³Ό 24λ¥Ό λ”ν•΄μ¤€λ‹¤.

μ΄λ ‡κ² ν•¨μμ μ—°μ‚°μ΄ λλ‚κ² λλ©΄ ν•¨μμ—μ„ μ‚¬μ©ν•λ ¤κ³  μ €μ¥ν•΄λ’€λ λ°μ΄ν„°λ“¤μ„ μ†λ©Έμ‹ν‚¤κ² λλ”λ°, μ΄λ ‡κ² ν•¨μ νΈμ¶ μ‹μ— μ‚¬μ©ν•κ³  μΆ…λ£ μ‹μ— μ†λ©Έν•κ² λλ” λ¶€λ¶„μ„ **μ¤νƒ ν”„λ μ„(Stack Frame)**μ΄λΌκ³  ν•λ‹¤. μ¤νƒ μ‚¬μ©μ΄ μ™„λ£λλ©΄ κΉ”λ”ν•κ² μ •λ¦¬ ν›„μ— μΆ…λ£μ‹μΌμ•Ό μ—λ¬κ°€ λ‚μ§€ μ•λ”λ‹¤.   
μ—¬κΈ°μ„  ``` add rsp, 16 ```μΌλ΅ ν¬μΈν„°λ¥Ό λ³€κ²½ν•΄μ£Όλ” κ²ƒμΌλ΅ μ΄κΈ°ν™” ν•΄μ£Όμ—λ‹¤.

> μ¤νƒ μ‚¬μ© ν›„ μ •λ¦¬λ¥Ό ν•μ§€ μ•μΌλ©΄ μ¶©λ μ—λ¬κ°€ λ‚λ‹¤.   
![Alt Text](/assets/images/posts_img/basics/asm/stack/crashed.PNG)   

κΈ°μ΅΄μ rax, rbx κ°’μ„ λ³µμ›μ‹ν‚¤κ³  μ‹¶λ‹¤λ©΄ ν•¨μ νΈμ¶ λ¶€λ¶„ μ•λ’¤λ΅ push, popμ„ μ‚¬μ©ν•΄μ£Όλ©΄ κ°„νΈν•λ‹¤.

```
    push rax
    push rbx
    push 1
    push 2
    call MAX
    PRINT_DEC 8, rax
    NEWLINE
    add rsp, 16 ; μ¤νƒ μ΄κΈ°ν™”. μ• ν•΄μ£Όλ©΄ μ—λ¬λ‚¨ 
    pop rbx
    pop rax
```

***

## π‘» κΈ€μ„ λ§μΉλ©°
μ΄λ² μ‹κ°„μ—λ” μ¤νƒ λ©”λ¨λ¦¬μ™€ μ¤νƒ ν”„λ μ„μ— λ€ν•΄ μ•μ•„λ³΄μ•λ‹¤. C++μ–Έμ–΄λ¥Ό κ³µλ¶€ν•λ©΄μ„ κ°λ…μ„ ν™•μ‹¤ν μµν”κΈ° λ•λ¬Έμ— μ΄λ² ν¬μ¤ν…μ„ ν•λ©΄μ„λ” λ³µμµ κ²Έ λ§λ¬΄λ¦¬ μ •λ¦¬λ¥Ό ν•λ” μ‹κ°„μ„ κ°€μ΅λ‹¤. κ·Έλμ„ κ°λ…λ³΄λ‹¨ μ¶”κ°€μ μΈ μ„¤λ…λ“¤μ„ μ μΌλ©΄μ„ λ¨Έλ¦Ώμ†μ— κ°λ…μ„ ν™•λ¦½ μ‹μΌ°λ‹¤. κ³µλ¶€ν•κΈ° μ „μ—” μ¤νƒμ΄λΌ ν•¨μ€ λ°μ΄ν„° μ €μ¥λ°©μ‹, ν›„μ…μ„ μ¶ λ°–μ— μ•μ§€ λ»ν–λ”λ° μ΄μ λ” μ½”λ“μ—μ„ λ³€μλ¥Ό μ„ μ–Έν•κ±°λ‚ ν•¨μλ¥Ό λ§λ“¤λ©΄ λ°μ΄ν„°κ°€ μ–΄λ””μ— μ €μ¥λλ” μ§€λ¥Ό ν™•μ‹¤ν μ•κ² λμ—λ‹¤.

***

_[μ†μ¤μ½”λ“ λ³΄λ¬κ°€κΈ°](https://github.com/choi-dan-di/study_assembly/blob/main/stack.asm)_

***

_μ¶μ²_   
_[μΈν”„λ° Rookiesλ‹ κ°•μ](https://inf.run/bje8)_   